\ProvidesPackage{thaixelatex}

\DeclareOption{english}{\englishtrue}

% Package options:
\newif\ifenglish\englishfalse
\ProcessOptions

%% font setup
\RequirePackage{fontspec}
\defaultfontfeatures{Mapping=tex-text}

%% Thai language setup
\XeTeXlinebreaklocale 'th_TH'
\XeTeXlinebreakskip = 0pt plus 0.2pt minus 0.2pt

% --- Thai fonts (macOS fallback) ---
\IfFontExistsTF{Thonburi}{
  \newfontfamily\thaifont[Script=Thai,Scale=MatchLowercase]{Thonburi}
}{
  \newfontfamily\thaifont[Script=Thai,Scale=MatchLowercase]{Tahoma}
}

\IfFontExistsTF{Sukhumvit Set}{
  \newfontfamily\thaifontsf[Script=Thai,Scale=MatchLowercase]{Sukhumvit Set}
}{
  \newfontfamily\thaifontsf[Script=Thai,Scale=MatchLowercase]{Helvetica}
}

\IfFontExistsTF{Courier New}{
  \newfontfamily\thaifonttt[Scale=MatchLowercase]{Courier New}
}{
  \newfontfamily\thaifonttt[Scale=MatchLowercase]{Menlo}
}

% --- Latin fonts (macOS fallback) ---
\IfFontExistsTF{Times New Roman}{
  \setmainfont{Times New Roman}
}{
  \setmainfont{Serif}
}

\IfFontExistsTF{Helvetica}{
  \setsansfont{Helvetica}
}{
  \setsansfont{Arial}
}

\IfFontExistsTF{Courier New}{
  \setmonofont{Courier New}
}{
  \setmonofont{Menlo}
}

%% math setup with fallback
\RequirePackage{amsmath}
\RequirePackage{unicode-math}

\IfFontExistsTF{Latin Modern Math}{
  \setmathfont{Latin Modern Math}
}{
  \IfFontExistsTF{XITS Math}{
    \setmathfont{XITS Math}
  }{
    \IfFontExistsTF{TeX Gyre Termes Math}{
      \setmathfont{TeX Gyre Termes Math}
    }{
      \IfFontExistsTF{Cambria Math}{
        \setmathfont{Cambria Math}
      }{
        % ถ้าไม่เจออะไรเลย จะใช้ค่า default ของ unicode-math
      }
    }
  }
}

\def\th@fam{0}
\let\th@thaifont=\thaifont
\let\th@thaifontsf=\thaifontsf
\let\th@thaifonttt=\thaifonttt
\def\thaifont{\def\th@fam{0}\th@thaifont}
\def\thaifontsf{\def\th@fam{1}\th@thaifontsf}
\def\thaifonttt{\def\th@fam{2}\th@thaifonttt}

\newcommand\th@englishfont{%
\ifcase\th@fam
  \rmfamilylatin
\or
  \sffamilylatin
\or
  \ttfamilylatin
\fi
}

\RequirePackage[Latin,Thai]{ucharclasses}
\ifenglish
  \def\thaifontrm{\thaifont}
  \setTransitionsFor{Thai}{\begingroup\hyphenrules{thai}\csname thaifont\familytype\endcsname}{\endgroup}
\else
  \setTransitionsForLatin{\begingroup\hyphenrules{english}\th@englishfont}{\endgroup}
\fi

\RequirePackage{polyglossia}
\ifenglish
  \setdefaultlanguage{english}
  \setotherlanguage{thai}
\else
  \setdefaultlanguage{thai}
  \setotherlanguage{english}
  \frenchspacing
\fi

%% spacing
\RequirePackage{setspace}
\let\@xfloat=\latex@xfloat % revert setspace patch of floating environments
\ifenglish
\else
\setstretch{1.35}
\AtBeginDocument{
  \setlength\abovedisplayskip{7.5pt plus 2.0pt minus 5.0pt}
  \setlength\belowdisplayskip{7.5pt plus 2.0pt minus 5.0pt}
  \setlength\belowdisplayshortskip{4.5pt plus 3.0pt minus 3.0pt}
}
\fi
